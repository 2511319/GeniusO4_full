\###############################################################################

# AugmentCode Instruction File

# Telegram Mini-App + Desktop JWT + 5-—É—Ä–æ–≤–Ω–µ–≤–∞—è RBAC + Firestore

# –ü—Ä–æ–µ–∫—Ç ¬´GeniusO4¬ª (FastAPI / React / Cloud Run)

\###############################################################################

## 0. –¶–µ–ª—å (rev‚Äë2)

* Mini‚ÄëApp –≤ Telegram ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞.
* –°—Å—ã–ª–∫–∞ ¬´–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ¬ª ‚Äî –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π JWT –Ω–∞ 10‚ÄØ–º–∏–Ω.
* **–†–æ–ª–∏**: admin, moderator, vip, premium, user.
* Firestore —Ö—Ä–∞–Ω–∏—Ç —Ä–æ–ª–∏ + –ø–æ–¥–ø–∏—Å–∫–∏.
* **–ù–ï–¢**: –∫–æ–º–∞–Ω–¥ ¬´–ó–∞–ø—Ä–æ—Å –∞–Ω–∞–ª–∏–∑–∞¬ª, ¬´–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–Ω–∞–ª–∏–∑¬ª, ¬´–ò—Å—Ç–æ—Ä–∏—è –æ—Ç—á—ë—Ç–æ–≤¬ª ‚Äî –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–∑–∂–µ –ø—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏.
* **–ë—ç–∫–ª–æ–≥** (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —Ç–µ–ø–µ—Ä—å):

  * Natural‚Äëlanguage –∑–∞–ø—Ä–æ—Å—ã.
  * ¬´–í–æ–ø—Ä–æ—Å –∫ –º–æ–¥–µ–ª–∏¬ª (LLM‚Äë—á–∞—Ç).

---

## 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
poetry add python-jose[cryptography] python-telegram-bot==21.2 telegram-webapp-auth==0.4.0
```

Secrets: `TELEGRAM_BOT_TOKEN`, `JWT_SECRET_KEY`.

---

## 2. Firestore —Å—Ö–µ–º–∞

```
users/{telegram_id}          { username, first_name, last_name, role }
subscriptions/{telegram_id}  { level, expires_at }
watchlists/{telegram_id}     { symbols: [str] }
flags/{analysis_ulid}        { reason, flagged_by, ts }
analyses/{ulid}              { owner_id, json_result, created_at }  #TTL 30d
```

---

## 3. Middleware, RBAC –∏ dependencies

(–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ rev‚Äë1 ‚Äî —Ñ–∞–π–ª `middleware/telegram_webapp.py` –∏ `require_role()` —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã)

---

## 4. –ù–æ–≤—ã–µ API‚Äë—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (admin / moderator / watchlist)

*–§–∞–π–ª—ã*:

```
backend/app/api/routers/
  ‚îú‚îÄ admin.py       # —É–∂–µ –µ—Å—Ç—å set_role
  ‚îú‚îÄ mod.py         # moderator actions
  ‚îî‚îÄ watch.py       # watchlist CRUD
```

### 4.1 admin.py (–¥–æ–±–∞–≤–∏—Ç—å)

```python
@router.get('/stats')
async def stats():
    # –≤–µ—Ä–Ω–∏ count –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Ä–æ–ª—è–º + –∞–∫—Ç–∏–≤–Ω—ã—Ö vip/premium
```

```python
@router.post('/broadcast', summary='–†–∞–∑–æ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º')
async def broadcast(text: str):
    # –∏—Ç–µ—Ä–∞—Ü–∏—è –ø–æ user ids, PTB send_message
```

```python
@router.post('/gc', summary='–†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä.')
async def gc():
    # —É–¥–∞–ª–∏—Ç—å analyses > 30d
```

### 4.2 mod.py

```python
router = APIRouter(prefix='/moderator', tags=['moderator'], dependencies=[Depends(require_role('moderator'))])

@router.post('/ban')
async def ban(uid: int, days: int = 30):
    ...
@router.post('/unban')
async def unban(uid: int):
    ...
@router.post('/review_flag')
async def review_flag(ulid: str, reason: str):
    ...
```

### 4.3 watch.py

```python
router = APIRouter(prefix='/watch', tags=['watch'], dependencies=[Depends(require_role('premium'))])
@router.post('/set')
async def set_watch(symbols: list[str], uid=Depends(get_uid)):
    db.collection('watchlists').document(str(uid)).set({'symbols': symbols})
@router.get('/get')
async def get_watch(uid=Depends(get_uid)):
    return db.collection('watchlists').document(str(uid)).get().to_dict()
```

---

## 5. Telegram‚Äë–±–æ—Ç: –∫–æ–º–∞–Ω–¥—ã –∏ UI

### 5.1 –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é `/start`

```
[  –û—Ç–∫—Ä—ã—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª  ]
[  –ú–æ–π watch‚Äë–ª–∏—Å—Ç    ] [  –ù–∞—Å—Ç—Ä–æ–π–∫–∏  ]
```

### 5.2 –ö–æ–º–∞–Ω–¥—ã

| –†–æ–ª—å      | –ö–æ–º–∞–Ω–¥—ã                                  | –û—Ç–≤–µ—Ç                    |
| --------- | ---------------------------------------- | ------------------------ |
| user      | `/watch BTC,ETH` ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ | ¬´‚úÖ Watch‚Äë–ª–∏—Å—Ç –æ–±–Ω–æ–≤–ª—ë–Ω¬ª  |
| user      | `/settings lang=ru tz=UTC+3`             | ¬´üõ† –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã¬ª |
| moderator | `/ban <@id> 15` / `/unban <@id>`         | —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω           |
| moderator | `/review <ulid> <reason>`                | –ø–æ–º–µ—á–∞–µ—Ç –æ—Ç—á—ë—Ç —Ñ–ª–∞–≥–æ–º    |
| admin     | `/setrole <@id> vip 60`                  | —Ä–æ–ª—å+–ø–æ–¥–ø–∏—Å–∫–∞ –≤—ã–¥–∞–Ω—ã     |
| admin     | `/stats` / `/broadcast <—Ç–µ–∫—Å—Ç>` / `/gc`  | –∞–¥–º–∏–Ω‚Äë—Ñ—É–Ω–∫—Ü–∏–∏            |

*–•–µ–ª–ø‚Äë–∫–æ–º–∞–Ω–¥–∞* `/help` –ø–µ—Ä–µ—á–∏—Å–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∫–æ–º–∞–Ω–¥—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `role`.

---

## 6. Cron / Cloud Scheduler Jobs

* `expire_subs` ‚Äî –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ `vip/premium` –≤ `user`.
* `daily_digest` ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–≥–æ vip/premium —Å–æ–±—Ä–∞—Ç—å watch‚Äë–ª–∏—Å—Ç, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–¥–∫—É (—Ü–µ–Ω–∞, –∏–∑–º–µ–Ω–µ–Ω–∏–µ, MA‚Äë–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ) –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
* `prune_flags` ‚Äî —É–¥–∞–ª—è—Ç—å `flags` —Å—Ç–∞—Ä—à–µ 14‚ÄØ–¥–Ω.

---

## 7. React Mini‚ÄëApp

* –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª ¬´Watch‚Äë–ª–∏—Å—Ç¬ª (CRUD symbols).
* –ö–Ω–æ–ø–∫–∞ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª (—è–∑—ã–∫, —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å).
* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É ¬´–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ¬ª (–∫–∞–∫ rev‚Äë1).

---

## 8. —Ç–µ—Å—Ç—ã

* `test_watchlist.py` ‚Äî CRUD ok / –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ premium+.
* `test_mod_ban.py` ‚Äî moderator –±–∞–Ω–∏—Ç, –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.
* `test_admin_stats.py` ‚Äî admin stats 200.

---

## 9. –ë—ç–∫–ª–æ–≥ (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å)

* Natural‚Äëlanguage –∑–∞–ø—Ä–æ—Å—ã (NLP‚Üíparams).
* Q\&A –∫ –º–æ–¥–µ–ª–∏ (LLM chat‚Äëassistant).

---

## 10. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

* Mini‚ÄëApp —Å—Ç–∞—Ä—Ç—É–µ—Ç –±–µ–∑ –ª–æ–≥–∏–Ω–∞.
* CRUD watch‚Äë–ª–∏—Å—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è premium+.
* /ban –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø (403).
* /stats –≤—ã–≤–æ–¥–∏—Ç –∞–≥—Ä–µ–≥–∞—Ç—ã.
* Cron‚Äëjobs –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è (Cloud Logging).
* –í—Å–µ —Ç–µ—Å—Ç—ã –∑–µ–ª—ë–Ω—ã–µ, CI/CD –¥–µ–ø–ª–æ–π –±–µ–∑ –æ—à–∏–±–æ–∫.

\###############################################################################

# –ö–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞

\###############################################################################
