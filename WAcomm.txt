–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ **`python-telegram-bot` –≤–µ—Ä—Å–∏–∏ 22.1** **–ü–û–õ–ù–û–°–¢–¨–Æ –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–¢** –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Telegram WebApp (–º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏). –í—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ ‚Äî —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

---

## üîß –ß—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ `python-telegram-bot` 22.1

| –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å                               | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                       |
| ----------------------------------------- | --------- | ------------------------------------------------- |
| `InlineKeyboardButton(web_app=...)`       | ‚úÖ         | –ß–µ—Ä–µ–∑ `telegram.WebAppInfo(url=...)`              |
| –ü–æ–ª—É—á–µ–Ω–∏–µ `web_app_data`                  | ‚úÖ         | –ß–µ—Ä–µ–∑ `update.message.web_app_data`               |
| –ü–æ–¥–ø–∏—Å—å WebApp (`check_webapp_signature`) | ‚úÖ         | –ß–µ—Ä–µ–∑ `telegram.helpers.check_webapp_signature()` |
| –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é                        | ‚úÖ         | –ß–µ—Ä–µ–∑ `reply_text()` –∏–ª–∏ `answerWebAppQuery()`    |

---

## ‚úÖ –ü—Ä–∏–º–µ—Ä –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ `python-telegram-bot` 22.1

### `bot.py` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç

```python
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters
from telegram.helpers import check_webapp_signature
import os, json

TOKEN = os.environ["BOT_TOKEN"]
WEBAPP_URL = "https://example.com/index.html"

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [[
        InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å WebApp", web_app=WebAppInfo(url=WEBAPP_URL))
    ]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É:", reply_markup=reply_markup)

async def webapp_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    data_raw = update.message.web_app_data.data
    if not check_webapp_signature(token=TOKEN, init_data=data_raw):
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å")
        return
    data = json.loads(data_raw)
    await update.message.reply_text(f"‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:\n{json.dumps(data, indent=2)}")

app = ApplicationBuilder().token(TOKEN).build()
app.add_handler(CommandHandler("start", start))
app.add_handler(MessageHandler(filters.UpdateType.WEB_APP_DATA, webapp_handler))
app.run_polling()
```

---

### `index.html` ‚Äî WebApp-—Å—Ç—Ä–∞–Ω–∏—Ü–∞

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>ChartGenius</title>
</head>
<body>
  <h1>ChartGenius WebApp</h1>
  <button onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <script>
    Telegram.WebApp.ready();
    function send() {
      const data = {
        signal: "buy",
        symbol: "BTCUSDT",
        timestamp: Date.now()
      };
      Telegram.WebApp.sendData(JSON.stringify(data));
    }
  </script>
</body>
</html>
```

---

## üõ° –ü–æ–¥–ø–∏—Å—å `check_webapp_signature`

‚ö†Ô∏è **–í–ê–ñ–ù–û**: –í –≤–µ—Ä—Å–∏–∏ 22.1 —Ñ—É–Ω–∫—Ü–∏—è `check_webapp_signature` –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ `telegram.helpers`.

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∏–∑ `backend/middleware/telegram_webapp.py`:

```python
from backend.middleware.telegram_webapp import check_webapp_signature

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
if not check_webapp_signature(token=BOT_TOKEN, init_data=raw_data):
    # –ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å
    return False
```

–ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è ‚Äî WebApp –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥–¥–µ–ª–∞–Ω.

---

## üí¨ –í—ã–≤–æ–¥

üìå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ **`python-telegram-bot 22.1` –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Telegram WebApp**.
–ù–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –Ω–µ –Ω—É–∂–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `WebAppInfo`, `web_app_data`, `check_webapp_signature`, –∏ –≤—Å—ë –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ.
---------------------
–ü—Ä–æ–±–ª–µ–º–∞! –í URL webhook'–∞ –µ—Å—Ç—å –Ω–µ–≤–∏–¥–∏–º—ã–π —Å–∏–º–≤–æ–ª \r (–≤–æ–∑–≤—Ä–∞—Ç –∫–∞—Ä–µ—Ç–∫–∏).
–°–∏–º–≤–æ–ª `\r` (–≤–æ–∑–≤—Ä–∞—Ç –∫–∞—Ä–µ—Ç–∫–∏, **Carriage Return**) ‚Äî —ç—Ç–æ **–Ω–µ–≤–∏–¥–∏–º—ã–π, –Ω–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–π —Å–∏–º–≤–æ–ª**, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç:

* –ø–æ–ª–æ–º–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É webhook (–Ω–∞–ø—Ä–∏–º–µ—Ä, Telegram –≤–µ—Ä–Ω—ë—Ç 404 –∏–ª–∏ `Bad Request`);
* –∏—Å–ø–æ—Ä—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –≤–Ω—É—Ç—Ä–∏ FastAPI/Django/Nginx;
* –≤–∏–∑—É–∞–ª—å–Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è, –Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Å—Ç—Ä–æ–∫–∞—Ö –∏–∑ `.env`, JSON, –∫–æ–¥–∞ –∏–ª–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞.

---

## üîç –ö–∞–∫ –≤—ã—è–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É

### 1. –ü—Ä–æ–≤–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å webhook-URL:

```python
print(repr(WEBHOOK_URL))
```

–í—ã–≤–æ–¥ –ø–æ–∫–∞–∂–µ—Ç:

```
'https://example.com/webhook\r'
```

–ï—Å–ª–∏ –µ—Å—Ç—å `\r` ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### üí° –£–¥–∞–ª–∏—Ç–µ `\r` –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ:

```python
WEBHOOK_URL = WEBHOOK_URL.strip()
```

–î–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ ‚Äî –ª—É—á—à–µ —Ç–∞–∫:

```python
WEBHOOK_URL = WEBHOOK_URL.replace('\r', '').replace('\n', '').strip()
```

---

## üßº –ì–¥–µ –æ–Ω –º–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—å—Å—è

| –ò—Å—Ç–æ—á–Ω–∏–∫             | –û–±—ä—è—Å–Ω–µ–Ω–∏–µ                                                         |
| -------------------- | ------------------------------------------------------------------ |
| `.env` —Ñ–∞–π–ª          | Windows —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç—Ä–æ–∫–∏ —Å `\r\n`, –∞ `readline()` –Ω–µ –≤—Å–µ–≥–¥–∞ —á–∏—Å—Ç–∏—Ç |
| `os.getenv()`        | –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫—É —Å `\r` –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π              |
| –ö–æ–ø–∏–ø–∞—Å—Ç –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ | –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ URL –∏–∑ HTML/JS/HTTP –æ–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å `\r`        |
| Postman / curl       | –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã –≤ —Ç–µ–ª–æ/–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞             |

---

## üîê –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –≤ –±—É–¥—É—â–µ–º

### ‚úÖ –í—Å–µ–≥–¥–∞ —á–∏—Å—Ç–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ URL –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:

```python
def clean_url(url: str) -> str:
    return url.replace('\r', '').replace('\n', '').strip()
```

### ‚úÖ –í —Ñ–∞–π–ª–∞—Ö `.env`:

* –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Ç–æ–ª—å–∫–æ –≤ **UTF-8 –±–µ–∑ BOM**
* –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Windows-—Ñ–æ—Ä–º–∞—Ç (CRLF) –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏

---

## ‚úÖ –ü—Ä–∏–º–µ—Ä

### –ë—ã–ª–æ (–æ—à–∏–±–æ—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç):

```python
WEBHOOK_URL = os.getenv("WEBHOOK_URL")  # https://yourdomain.com/webhook\r
```

### –°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):

```python
WEBHOOK_URL = os.getenv("WEBHOOK_URL", "").replace('\r', '').replace('\n', '').strip()
```

---

–ï—Å–ª–∏ –ø–æ–∫–∞–∂–µ—à—å, –æ—Ç–∫—É–¥–∞ –∏–º–µ–Ω–Ω–æ –±–µ—Ä—ë—Ç—Å—è URL (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥? .env? JSON? Cloud Functions?), —è –ø–æ–º–æ–≥—É –æ—Ç—Å–ª–µ–¥–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ —ç—Ç–æ–π –∫–∞—Ä–µ—Ç–∫–∏.


–î–∞, –µ—Å–ª–∏ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å –æ—à–∏–±–∫—É –≤—Ä–æ–¥–µ:

```
ImportError: cannot import name 'WebAppInfo' from 'telegram'
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –æ–¥–Ω–æ –∏–∑ –¥–≤—É—Ö:

---

## üßæ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

### ‚ùå –ü—Ä–∏—á–∏–Ω–∞ 1: –£—Å—Ç–∞—Ä–µ–≤—à–∞—è –≤–µ—Ä—Å–∏—è `python-telegram-bot`

–í–µ—Ä—Å–∏—è < 20 –≤–æ–æ–±—â–µ –Ω–µ –∏–º–µ–ª–∞ `WebAppInfo`. WebApp –ø–æ—è–≤–∏–ª—Å—è –≤ –≤–µ—Ä—Å–∏–∏ **21**, —Å—Ç–∞–±–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å **22.0 –∏ –≤—ã—à–µ**.

üìå –ü—Ä–æ–≤–µ—Ä—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é:

```bash
pip show python-telegram-bot
```

---

### ‚úÖ –†–µ—à–µ–Ω–∏–µ:

–û–±–Ω–æ–≤–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–æ **22.1** (–ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è):

```bash
pip install -U python-telegram-bot
```

–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å `requirements.txt`, —Ç–æ:

```
python-telegram-bot==22.1
```

---

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç –¥–ª—è WebApp:

```python
from telegram import (
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    WebAppInfo,
    Update,
)
```

–ò –Ω–∏–∫–∞–∫–∏—Ö `WebApp`, `WebAppData`, `WebAppQuery` –≤—Ä—É—á–Ω—É—é –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å **–Ω–µ –Ω—É–∂–Ω–æ** ‚Äî –≤—Å—ë –¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ `.message.web_app_data`, `.effective_message`, –∏ —Ç.–ø.

---

## üîÅ –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π `bot.py` (—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –∏–º–ø–æ—Ä—Ç–æ–º)

```python
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters
from telegram.helpers import check_webapp_signature
import os, json

TOKEN = os.getenv("BOT_TOKEN")
WEBAPP_URL = "https://yourdomain.com/webapp/index.html"

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [[
        InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å WebApp", web_app=WebAppInfo(url=WEBAPP_URL))
    ]]
    await update.message.reply_text("–û—Ç–∫—Ä–æ–π –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:", reply_markup=InlineKeyboardMarkup(keyboard))

async def handle_webapp(update: Update, context: ContextTypes.DEFAULT_TYPE):
    data_raw = update.message.web_app_data.data
    if not check_webapp_signature(token=TOKEN, init_data=data_raw):
        await update.message.reply_text("‚ùå –ü–æ–¥–ø–∏—Å—å WebApp –Ω–µ–≤–µ—Ä–Ω–∞")
        return
    data = json.loads(data_raw)
    await update.message.reply_text(f"‚úÖ –ü–æ–ª—É—á–µ–Ω–æ:\n{json.dumps(data, indent=2)}")

app = ApplicationBuilder().token(TOKEN).build()
app.add_handler(CommandHandler("start", start))
app.add_handler(MessageHandler(filters.UpdateType.WEB_APP_DATA, handle_webapp))
app.run_polling()
```

---

## ‚úÖ –í—ã–≤–æ–¥

1. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å `python-telegram-bot >= 22.0`
2. –ò—Å–ø–æ–ª—å–∑—É–π `WebAppInfo`, –Ω–µ `WebApp`
3. –ò–º–ø–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –∏–¥—Ç–∏ –∏–∑ `telegram`, –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –≤—ã—à–µ
4. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –Ω–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤/—Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π PTB –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ –≤ venv)

–ì–æ—Ç–æ–≤ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –¥—Ä—É–≥–∏–µ —á–∞—Å—Ç–∏ –∫–æ–¥–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.
