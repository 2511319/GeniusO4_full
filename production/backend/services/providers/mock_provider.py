import logging
import json
from .base import LLMProvider, LLMResponse, LLMProviderError

logger = logging.getLogger(__name__)

class MockProvider(LLMProvider):
    """Mock –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ fallback –∫–æ–≥–¥–∞ OpenAI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"""
    
    def __init__(self):
        super().__init__()
        self.model = "mock-gpt-4o-mini"
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω Mock –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
    
    def generate(self, messages, **kwargs):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç mock –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞"""
        try:
            logger.info("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è mock –æ—Ç–≤–µ—Ç–∞...")
            
            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            last_message = messages[-1] if messages else {"content": ""}
            content = last_message.get("content", "").lower()
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π mock –æ—Ç–≤–µ—Ç
            if "–∞–Ω–∞–ª–∏–∑" in content and ("btc" in content or "bitcoin" in content):
                mock_response = self._generate_crypto_analysis()
            elif "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏" in content:
                mock_response = self._generate_trading_recommendations()
            elif "–ø—Ä–æ–≥–Ω–æ–∑" in content:
                mock_response = self._generate_price_prediction()
            else:
                mock_response = self._generate_general_analysis()
            
            logger.info("‚úÖ Mock –æ—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω")
            
            return LLMResponse(
                content=mock_response,
                model=self.model,
                usage={
                    'prompt_tokens': len(str(messages)),
                    'completion_tokens': len(mock_response),
                    'total_tokens': len(str(messages)) + len(mock_response)
                }
            )
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ mock –æ—Ç–≤–µ—Ç–∞: {e}")
            raise LLMProviderError(f"–û—à–∏–±–∫–∞ mock –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞: {e}")
    
    def _generate_crypto_analysis(self):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç mock –∞–Ω–∞–ª–∏–∑ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã"""
        return """
## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ BTCUSDT

### –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è
- **–¶–µ–Ω–∞**: $43,250 (–¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ)
- **–¢—Ä–µ–Ω–¥**: –í–æ—Å—Ö–æ–¥—è—â–∏–π –Ω–∞ 4h —Ç–∞–π–º—Ñ—Ä–µ–π–º–µ
- **–û–±—ä–µ–º**: –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
- **RSI (14)**: 58.3 - –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞
- **MACD**: –ë—ã—á–∏–π —Å–∏–≥–Ω–∞–ª, –ª–∏–Ω–∏–∏ –≤—ã—à–µ –Ω—É–ª—è
- **Bollinger Bands**: –¶–µ–Ω–∞ –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –∫–∞–Ω–∞–ª–∞
- **Moving Averages**: –¶–µ–Ω–∞ –≤—ã—à–µ MA20 –∏ MA50

### –£—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è
- **–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ**: $44,000, $45,500
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞**: $42,000, $40,500

### –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —É–º–µ—Ä–µ–Ω–Ω–æ –±—ã—á—å–∏ —Å–∏–≥–Ω–∞–ª—ã. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ –ø—Ä–æ–±–æ–µ–º —É—Ä–æ–≤–Ω—è $44,000.

*–≠—Ç–æ –¥–µ–º–æ-–∞–Ω–∞–ª–∏–∑ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã*
"""
    
    def _generate_trading_recommendations(self):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç mock —Ç–æ—Ä–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"""
        return """
## üí° –¢–æ—Ä–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (4h-1d)
- **–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: LONG
- **–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞**: $42,800-$43,200
- **Take Profit**: $44,500 (–ø–µ—Ä–≤–∞—è —Ü–µ–ª—å), $45,800 (–≤—Ç–æ—Ä–∞—è —Ü–µ–ª—å)
- **Stop Loss**: $41,500
- **Risk/Reward**: 1:2.5

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (1d-1w)
- **–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: HOLD/LONG
- **–¶–µ–ª–µ–≤–∞—è –∑–æ–Ω–∞**: $46,000-$48,000
- **–†–∏—Å–∫–∏**: –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –∫ $40,000

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏
- –ù–µ –±–æ–ª–µ–µ 2% –¥–µ–ø–æ–∑–∏—Ç–∞ –Ω–∞ —Å–¥–µ–ª–∫—É
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–µ—Ä–≤–æ–π —Ü–µ–ª–∏
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±—ä–µ–º–æ–≤ —Ç–æ—Ä–≥–æ–≤

*–≠—Ç–æ –¥–µ–º–æ-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã*
"""
    
    def _generate_price_prediction(self):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç mock –ø—Ä–æ–≥–Ω–æ–∑ —Ü–µ–Ω—ã"""
        return """
## üéØ –ü—Ä–æ–≥–Ω–æ–∑ —Ü–µ–Ω—ã BTCUSDT

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ (24-48 —á–∞—Å–æ–≤)
- **–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ä–æ—Å—Ç–∞**: 65%
- **–¶–µ–ª–µ–≤–∞—è –∑–æ–Ω–∞**: $44,200-$45,000
- **–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã**: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç—Å–∫–æ–∫, —Ä–æ—Å—Ç –æ–±—ä–µ–º–æ–≤

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ (1-2 –Ω–µ–¥–µ–ª–∏)
- **–°—Ü–µ–Ω–∞—Ä–∏–π 1 (60%)**: –†–æ—Å—Ç –∫ $46,500-$48,000
- **–°—Ü–µ–Ω–∞—Ä–∏–π 2 (40%)**: –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –∫ $40,000-$41,000

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ (1 –º–µ—Å—è—Ü)
- **–ë—ã—á–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π**: $50,000+
- **–ú–µ–¥–≤–µ–∂–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π**: $38,000-$40,000

### –§–∞–∫—Ç–æ—Ä—ã –≤–ª–∏—è–Ω–∏—è
- –ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏
- –ò–Ω—Å—Ç–∏—Ç—É—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–ø—Ä–æ—Å
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É—Ä–æ–≤–Ω–∏

*–≠—Ç–æ –¥–µ–º–æ-–ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã*
"""
    
    def _generate_general_analysis(self):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—â–∏–π mock –∞–Ω–∞–ª–∏–∑"""
        return """
## üìà –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–†—ã–Ω–æ–∫ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —É–º–µ—Ä–µ–Ω–Ω—É—é –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å —Å –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏.

### –ö–ª—é—á–µ–≤—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≤ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–π –∑–æ–Ω–µ
- –û–±—ä–µ–º—ã —Ç–æ—Ä–≥–æ–≤ –Ω–∞ —Å—Ä–µ–¥–Ω–µ–º —É—Ä–æ–≤–Ω–µ
- –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–º–∏ —Ä—ã–Ω–∫–∞–º–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –°–æ–±–ª—é–¥–µ–Ω–∏–µ —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–ª—é—á–µ–≤—ã—Ö —É—Ä–æ–≤–Ω–µ–π
- –î–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è

*–≠—Ç–æ –¥–µ–º–æ-–∞–Ω–∞–ª–∏–∑ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã ChartGenius*
"""
